<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../../../img/favicon.ico">
  <title>3. C to TVM Library - DOC.TON.DEV</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "3. C to TVM Library";
    var mkdocs_page_input_path = "Compilers\\LLVM Compiler\\3. C to TVM Library.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/rust.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../../.." class="icon icon-home"> DOC.TON.DEV</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../../..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Compilers</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../ABI Specification/">ABI Specification</a>
                </li>
                <li class="">
                    
    <a class="" href="../../Intro/">Intro</a>
                </li>
                <li class="">
                    
    <a class="" href="../../Linker CLI/">Linker CLI</a>
                </li>
                <li class=" current">
                    
    <span class="caption-text">LLVM Compiler</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../1. Compiler Highlights/">1. Compiler Highlights</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../2. C Support Status/">Language Features</a>
                </li>
                <li class="toctree-l3 current">
                    
    <a class="current" href="./">3. C to TVM Library</a>
    <ul class="subnav">
            
    <li class="toctree-l4"><a href="#general-program-structure">General Program Structure</a></li>
    

    <li class="toctree-l4"><a href="#public-methods">Public methods</a></li>
    

    <li class="toctree-l4"><a href="#global-and-persistent-variables">Global and persistent variables</a></li>
    

    <li class="toctree-l4"><a href="#low-level-implementation-details">Low-Level Implementation Details</a></li>
    

    <li class="toctree-l4"><a href="#library-structure">Library Structure</a></li>
    

    <li class="toctree-l4"><a href="#inclusion-pattern">Inclusion Pattern</a></li>
    
        <ul>
        
            <li><a class="toctree-l5" href="#detailed-file-description">Detailed File Description</a></li>
        
            <li><a class="toctree-l5" href="#tvmh">TVM.h</a></li>
        
            <li><a class="toctree-l5" href="#smart-contract-infoh-smart-contract-infoinc-define-ton-structure-headerinc">smart-contract-info.h, smart-contract-info.inc, define-ton-structure-header.inc</a></li>
        
            <li><a class="toctree-l5" href="#messageh-and-messageinc">message.h and message.inc</a></li>
        
        </ul>
    

    <li class="toctree-l4"><a href="#notes-on-the-abi">Notes on the ABI</a></li>
    

    </ul>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../4. Debugging Options/">4. Debugging Options</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">Solidity Compiler</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../../Solidity Compiler/Reference Guide/">Reference Guide</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../Solidity Compiler/Solidity Support status/">Solidity Support Status</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../Solidity Compiler/Usage/">Usage</a>
                </li>
    </ul>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">FAQ</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../../FAQ/">TON Dev Documentation</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../FAQ/SDK and Integration/">SDK and Integration</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../FAQ/Smart Contracts/">Smart Contracts</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../FAQ/Solidity Compiler/">Solidity Compiler</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../FAQ/TON and TVM/">TON and TVM</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Misc</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../../Misc/Glossary/">The Moonspeak</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">SDK</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../../SDK/Installation/">Installation</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../SDK/Overview/">Overview</a>
                </li>
                <li class="">
                    
    <span class="caption-text">Auxiliaries</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../../../SDK/Auxiliaries/Getting Logs/">Getting Logs</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../../SDK/Auxiliaries/Installing Ubuntu VM/">Installing Ubuntu VM</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../../SDK/Auxiliaries/TON SDK CLI/">TON SDK CLI</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../../SDK/Auxiliaries/Troubleshooting/">Troubleshooting</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">Client Libraries</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <span class="caption-text">Library Modules</span>
    <ul class="subnav">
                <li class="toctree-l4">
                    
    <a class="" href="../../../SDK/Client Libraries/Library Modules/Contracts/">Contracts</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../SDK/Client Libraries/Library Modules/Crypto/">Crypto</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../SDK/Client Libraries/Library Modules/Overview/">Overview</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../SDK/Client Libraries/Library Modules/Queries/">Queries</a>
                </li>
    </ul>
                </li>
                <li class="toctree-l3">
                    
    <span class="caption-text">Using Libraries</span>
    <ul class="subnav">
                <li class="toctree-l4">
                    
    <a class="" href="../../../SDK/Client Libraries/Using Libraries/Node.js/">Node.js</a>
                </li>
                <li class="toctree-l4">
                    
    <a class="" href="../../../SDK/Client Libraries/Using Libraries/Rust/">Rust</a>
                </li>
    </ul>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">Local node</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../../../SDK/Local node/Local Node/">Local Node</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../../SDK/Local node/Node SE Giver/">Node SE Giver</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">TON Labs Testnet</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../../../SDK/TON Labs Testnet/Testnet Giver/">Testnet Giver</a>
                </li>
    </ul>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">TON Blockchain</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../../TON Blockchain/Gal Calculation Basics/">Gas Calculation Basics</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../TON Blockchain/Replay Attack Protection/">Replay Attack Protection</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../TON Blockchain/Storage Fee Calculation/">Storage Fee Calculation</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../TON Blockchain/TVM Error Codes/">TVM Error Codes</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../..">DOC.TON.DEV</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../..">Docs</a> &raquo;</li>
    
      
        
          <li>LLVM Compiler &raquo;</li>
        
      
        
          <li>Compilers &raquo;</li>
        
      
    
    <li>3. C to TVM Library</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h2 id="general-program-structure">General Program Structure</h2>
<p>Traditional C programs have one main function, which in turn calls other functions. Contracts look more like classes with multiple functions, callable from outside. Also, for more similarity, each contract has its own memory (it is called <strong>persistent</strong> in TVM).</p>
<p>So, a typical contract in C has no main function, but has several public methods, and several persistent variables.</p>
<h2 id="public-methods">Public methods</h2>
<p>A function becomes a public method for contract X, if it is declared in the <strong>X.abi</strong> file.</p>
<h2 id="global-and-persistent-variables">Global and persistent variables</h2>
<p>Programs written in C language call code once: before the code starts working all data is initialized; after execution is over, all data is disposed of. As far as contracts are concerned, they retain their state between contract methods invocations. So there are two different types of global variables:</p>
<ul>
<li>traditional global C variables are forgotten after the method stops working;</li>
<li>persistent variables, which are stored in blockchain; these values remain (persist) between method invocations.</li>
</ul>
<p>Global variables can be made persistent by adding the <em>_persistent</em> postfix:</p>
<pre><code class="Scala">int x = 0;             // Forgotten after each method invocation
int y_persistent = 0;  // Kept in blockchain and does not lose its value
</code></pre>

<h2 id="low-level-implementation-details">Low-Level Implementation Details</h2>
<p>The above primitives are written by TON Labs team, and TVM does not really impose this format of communication. In fact, a contract has a single entry point. When a request (message) is made it, a slice (that is, a bit string) is provided along with it.</p>
<p>A low-level part of the TON standard library contains a <strong>selector:</strong> a special function that parses a slice and calls a given contract method. Method selection is determined by a method id specified in the initial bytes of the slice. The remaining slice elements are stored into a working slice.</p>
<p>Contract methods are generated by a special script according to an abi file. Then they are put into a <strong>X_wrapper.c file</strong>, where X is the name of the contract. These methods <em>deserialize</em> parameters from a <em>slice</em> and transfer them as parameters to the proper contract function implementation.</p>
<h2 id="library-structure">Library Structure</h2>
<p>The library is a set of files that have to be included into your contract code directly or indirectly to implement predefined C structures. These structures are designed to ensure smoother development of code that can be compiled to TVM Assembly.</p>
<p>For learning purposes, we provide a commented sample contract that shows how library files are included in it, how they work, and how the code is written with regard to it. This contract is a blockchain transfer transaction designed for a Piggy Bank dapp.</p>
<p>Note that the library has a cross-reference structure. In other words, files, included into the final smart contract (.h headers with declarations), in turn, include other files (.inc with definitions) from the library.</p>
<p>Also, there are .inc or .c files that contain implementations for declarations and definitions. But, these are not included into other files or into the contract itself.</p>
<p>The file naming convention indicates that there are files implementing the TON-compatible C structures, messaging logic, contract data (fields) and files that allow defining TVM-specific components in C.</p>
<p>The <strong>arguments.h</strong> file enables faster function argument parsing without introducing additional structures.</p>
<h2 id="inclusion-pattern">Inclusion Pattern</h2>
<h3 id="detailed-file-description">Detailed File Description</h3>
<p>The sample smart contract includes several header files. Basically, they allow creating a valid version of a smart-contract.</p>
<p>Given follow-up library revisions and modifications, as well as project particularities, you may find that some files are redundant for you.</p>
<pre><code class="Scala">#include &quot;ton-sdk/tvm.h&quot;
#include &quot;ton-sdk/messages.h&quot;
#include &quot;ton-sdk/arguments.h&quot;
#include &quot;ton-sdk/smart-contract-info.h&quot;
</code></pre>

<p>The body of the contract contains arguments that are parsed, business logic stored in permanent memory and the final message. The first part of the message is taken from the ABI protocol and the second is generated by the contract (big integer, 46 symbols).</p>
<h3 id="tvmh">TVM.h</h3>
<p>The <strong>tvm.h</strong> file declares general C structures.</p>
<p><strong>Note</strong>: Bodies of functions for value manipulation are implemented in the <strong>tvm.c</strong> file, which is compiled along with your source files and linked to the resulting contract binary file.</p>
<h3 id="smart-contract-infoh-smart-contract-infoinc-define-ton-structure-headerinc">smart-contract-info.h, smart-contract-info.inc, define-ton-structure-header.inc</h3>
<p>The <strong>smart-contract-info.h</strong> header file defines SmartContractInfo TON-specific structure. The fields of the structure are declared in <strong>smart-contract-info.inc</strong> file. File <strong>define-ton-structure-header.inc</strong> contains some helper macroses, which declare:</p>
<ul>
<li><strong>SmartContractInfo</strong> structure by itself</li>
<li>builder and cell serialization functions</li>
<li>slice and cell deserialization functions</li>
</ul>
<blockquote>
<p><strong>Note</strong>: Please, refer to the TVM specification for more info on the concept of <em>bag of cells</em>, cell serialization and slice deserialization.</p>
</blockquote>
<p>The <strong>smart-contract-info.inc</strong> defines the contract field structure in the TON_STRUCT macro. The macro lists the supported fields with names, lengths and types.</p>
<pre><code class="Scala">#define TON_STRUCT_NAME SmartContractInfo
#define TON_STRUCT \\
    FIELD_CONSTANT_UNSIGNED(smc_info, 0x076ef1ea, 32) \\
    FIELD_UNSIGNED(actions, 16) \\
    FIELD_UNSIGNED(msgs_sent, 16) \\
    FIELD_UNSIGNED(unixtime, 32) \\
    FIELD_UNSIGNED(block_lt, 64) \\
    FIELD_UNSIGNED(trans_lt, 64) \\
    FIELD_UNSIGNED(rand_seed, 256) \\
    FIELD_COMPLEX(balance_remaining, CurrencyCollection) \\
    FIELD_COMPLEX(myself, MsgAddressInt)
#include HEADER_OR_C
#undef HEADER_OR_C 
</code></pre>

<p>Below is field declarations and macroses in the above code are explained:</p>
<ul>
<li>The first line defines the structure name, <strong>SmartContractInfo</strong> (this macro is used in many points where structure name is necessary).</li>
<li><strong>FIELD_CONSTANT_UNSIGNED</strong> macro defines a constant ("virtual") field which is not really stored within a structure, but its value is placed into a slice at serialization and checked at deserialization.</li>
<li><strong>FIELD_UNSIGNED</strong> no in-depth explanation needed.</li>
<li><strong>FIELD_COMPLEX</strong> allows to define a nested structure.</li>
<li><strong>HEADER_OR_C</strong> macro includes either source or header file depending on the context. This macro is undefined after use to allow declaring the next structure in file (if exists) without warnings that a macro is already declared.</li>
</ul>
<p>This complicated system of includes and macroses defines a lot of useful functions and structures. For example, the function below from the contract returns balance information in compliance with the structure defined in the macro.</p>
<pre><code class="Scala">SmartContractInfo sc_info = get_SmartContractInfo();
int balance = sc_info.balance_remaining.grams.amount; 
</code></pre>

<h3 id="messageh-and-messageinc">message.h and message.inc</h3>
<p>The <strong>message.h</strong> file declares a macro to enable messaging procedures. In refers to the <strong>message.inc</strong> file where actual messaging rules are defined.</p>
<p>The <strong>message.inc</strong> maps messaging rules to structures and fields declared in the <strong>tvm.h</strong> and <strong>define-ton-struct-header.inc</strong> files.</p>
<p>The <strong>arguments.h</strong> file is covered above.</p>
<h2 id="notes-on-the-abi">Notes on the ABI</h2>
<p>Contract messages in TON Labs contracts are formatted according to ABI specifications. Currently only (u)int values are supported.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../4. Debugging Options/" class="btn btn-neutral float-right" title="4. Debugging Options">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../2. C Support Status/" class="btn btn-neutral" title="Language Features"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../2. C Support Status/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../4. Debugging Options/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../../..';</script>
    <script src="../../../js/theme.js" defer></script>
      <script src="../../../search/main.js" defer></script>

</body>
</html>
