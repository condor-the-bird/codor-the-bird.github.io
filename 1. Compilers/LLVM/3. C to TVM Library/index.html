<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../../img/favicon.ico">
        <title>3. C to TVM Library - DOC.TON.DEV</title>
        <link href="../../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="../../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="../../..">DOC.TON.DEV</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li >
                                <a href="../../..">Home</a>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">1. Compilers <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../ABI Specification/">ABI Specification</a>
</li>
                                    
<li >
    <a href="../../Intro/">Intro</a>
</li>
                                    
<li >
    <a href="../../Linker CLI/">Linker CLI</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#">LLVM</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../1. Compiler Highlights/">1. Compiler Highlights</a>
</li>
            
<li >
    <a href="../2. C Support Status/">Language Features</a>
</li>
            
<li class="active">
    <a href="./">3. C to TVM Library</a>
</li>
            
<li >
    <a href="../4. Debugging Options/">4. Debugging Options</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">Solidity</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../Solidity/1. Support status/">Solidity Support Status</a>
</li>
            
<li >
    <a href="../../Solidity/2. Reference Guide/">2. Reference Guide</a>
</li>
            
<li >
    <a href="../../Solidity/3. Usage/">3. Usage</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">2. SDK <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../../2. SDK/1. Installation/">1. Installation</a>
</li>
                                    
<li >
    <a href="../../../2. SDK/2. Overview/">2. Overview</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#">Auxiliaries</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../2. SDK/Auxiliaries/Getting Logs/">Getting Logs</a>
</li>
            
<li >
    <a href="../../../2. SDK/Auxiliaries/Installing Ubuntu VM/">Installing Ubuntu VM</a>
</li>
            
<li >
    <a href="../../../2. SDK/Auxiliaries/TON SDK CLI/">TON SDK CLI</a>
</li>
            
<li >
    <a href="../../../2. SDK/Auxiliaries/Troubleshooting/">Troubleshooting</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">Client Libraries</a>
    <ul class="dropdown-menu">
            
  <li class="dropdown-submenu">
    <a href="#">Library Modules</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../2. SDK/Client Libraries/Library Modules/1. Overview/">1. Overview</a>
</li>
            
<li >
    <a href="../../../2. SDK/Client Libraries/Library Modules/2. Queries/">2. Queries</a>
</li>
            
<li >
    <a href="../../../2. SDK/Client Libraries/Library Modules/3. Crypto/">3. Crypto</a>
</li>
            
<li >
    <a href="../../../2. SDK/Client Libraries/Library Modules/4. Contracts/">4. Contracts</a>
</li>
    </ul>
  </li>
            
  <li class="dropdown-submenu">
    <a href="#">Using Libraries</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../2. SDK/Client Libraries/Using Libraries/2. Node.js/">2. Node.js</a>
</li>
            
<li >
    <a href="../../../2. SDK/Client Libraries/Using Libraries/3. Rust/">3. Rust</a>
</li>
    </ul>
  </li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">Local node</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../2. SDK/Local node/Local Node/">Local Node</a>
</li>
            
<li >
    <a href="../../../2. SDK/Local node/Node SE Giver/">Node SE Giver</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#">TON Labs Testnet</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../../2. SDK/TON Labs Testnet/Testnet Giver/">Testnet Giver</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">3. TON Blockchain <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../../3. TON Blockchain/Gal Calculation Basics/">Gas Calculation Basics</a>
</li>
                                    
<li >
    <a href="../../../3. TON Blockchain/Replay Attack Protection/">Replay Attack Protection</a>
</li>
                                    
<li >
    <a href="../../../3. TON Blockchain/Storage Fee Calculation/">Storage Fee Calculation</a>
</li>
                                    
<li >
    <a href="../../../3. TON Blockchain/TVM Error Codes/">TVM Error Codes</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">4. FAQ <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../../4. FAQ/">TON Dev Documentation</a>
</li>
                                    
<li >
    <a href="../../../4. FAQ/SDK and Integration/">SDK and Integration</a>
</li>
                                    
<li >
    <a href="../../../4. FAQ/Smart Contracts/">Smart Contracts</a>
</li>
                                    
<li >
    <a href="../../../4. FAQ/Solidity Compiler/">Solidity Compiler</a>
</li>
                                    
<li >
    <a href="../../../4. FAQ/TON and TVM/">TON and TVM</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">5. Misc <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../../5. Misc/Glossary/">The Moonspeak</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li >
                                <a rel="next" href="../2. C Support Status/">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li >
                                <a rel="prev" href="../4. Debugging Options/">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#general-program-structure">General Program Structure</a></li>
        <li class="main "><a href="#public-methods">Public methods</a></li>
        <li class="main "><a href="#global-and-persistent-variables">Global and persistent variables</a></li>
        <li class="main "><a href="#low-level-implementation-details">Low-Level Implementation Details</a></li>
        <li class="main "><a href="#library-structure">Library Structure</a></li>
        <li class="main "><a href="#inclusion-pattern">Inclusion Pattern</a></li>
            <li><a href="#detailed-file-description">Detailed File Description</a></li>
            <li><a href="#tvmh">TVM.h</a></li>
            <li><a href="#smart-contract-infoh-smart-contract-infoinc-define-ton-structure-headerinc">smart-contract-info.h, smart-contract-info.inc, define-ton-structure-header.inc</a></li>
            <li><a href="#messageh-and-messageinc">message.h and message.inc</a></li>
        <li class="main "><a href="#notes-on-the-abi">Notes on the ABI</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h2 id="general-program-structure">General Program Structure</h2>
<p>Traditional C programs have one main function, which in turn calls other functions. Contracts look more like classes with multiple functions, callable from outside. Also, for more similarity, each contract has its own memory (it is called <strong>persistent</strong> in TVM).</p>
<p>So, a typical contract in C has no main function, but has several public methods, and several persistent variables.</p>
<h2 id="public-methods">Public methods</h2>
<p>A function becomes a public method for contract X, if it is declared in the <strong>X.abi</strong> file.</p>
<h2 id="global-and-persistent-variables">Global and persistent variables</h2>
<p>Programs written in C language call code once: before the code starts working all data is initialized; after execution is over, all data is disposed of. As far as contracts are concerned, they retain their state between contract methods invocations. So there are two different types of global variables:</p>
<ul>
<li>traditional global C variables are forgotten after the method stops working;</li>
<li>persistent variables, which are stored in blockchain; these values remain (persist) between method invocations.</li>
</ul>
<p>Global variables can be made persistent by adding the <em>_persistent</em> postfix:</p>
<pre><code class="Scala">int x = 0;             // Forgotten after each method invocation
int y_persistent = 0;  // Kept in blockchain and does not lose its value
</code></pre>

<h2 id="low-level-implementation-details">Low-Level Implementation Details</h2>
<p>The above primitives are written by TON Labs team, and TVM does not really impose this format of communication. In fact, a contract has a single entry point. When a request (message) is made it, a slice (that is, a bit string) is provided along with it.</p>
<p>A low-level part of the TON standard library contains a <strong>selector:</strong> a special function that parses a slice and calls a given contract method. Method selection is determined by a method id specified in the initial bytes of the slice. The remaining slice elements are stored into a working slice.</p>
<p>Contract methods are generated by a special script according to an abi file. Then they are put into a <strong>X_wrapper.c file</strong>, where X is the name of the contract. These methods <em>deserialize</em> parameters from a <em>slice</em> and transfer them as parameters to the proper contract function implementation.</p>
<h2 id="library-structure">Library Structure</h2>
<p>The library is a set of files that have to be included into your contract code directly or indirectly to implement predefined C structures. These structures are designed to ensure smoother development of code that can be compiled to TVM Assembly.</p>
<p>For learning purposes, we provide a commented sample contract that shows how library files are included in it, how they work, and how the code is written with regard to it. This contract is a blockchain transfer transaction designed for a Piggy Bank dapp.</p>
<p>Note that the library has a cross-reference structure. In other words, files, included into the final smart contract (.h headers with declarations), in turn, include other files (.inc with definitions) from the library.</p>
<p>Also, there are .inc or .c files that contain implementations for declarations and definitions. But, these are not included into other files or into the contract itself.</p>
<p>The file naming convention indicates that there are files implementing the TON-compatible C structures, messaging logic, contract data (fields) and files that allow defining TVM-specific components in C.</p>
<p>The <strong>arguments.h</strong> file enables faster function argument parsing without introducing additional structures.</p>
<h2 id="inclusion-pattern">Inclusion Pattern</h2>
<h3 id="detailed-file-description">Detailed File Description</h3>
<p>The sample smart contract includes several header files. Basically, they allow creating a valid version of a smart-contract.</p>
<p>Given follow-up library revisions and modifications, as well as project particularities, you may find that some files are redundant for you.</p>
<pre><code class="Scala">#include &quot;ton-sdk/tvm.h&quot;
#include &quot;ton-sdk/messages.h&quot;
#include &quot;ton-sdk/arguments.h&quot;
#include &quot;ton-sdk/smart-contract-info.h&quot;
</code></pre>

<p>The body of the contract contains arguments that are parsed, business logic stored in permanent memory and the final message. The first part of the message is taken from the ABI protocol and the second is generated by the contract (big integer, 46 symbols).</p>
<h3 id="tvmh">TVM.h</h3>
<p>The <strong>tvm.h</strong> file declares general C structures.</p>
<p><strong>Note</strong>: Bodies of functions for value manipulation are implemented in the <strong>tvm.c</strong> file, which is compiled along with your source files and linked to the resulting contract binary file.</p>
<h3 id="smart-contract-infoh-smart-contract-infoinc-define-ton-structure-headerinc">smart-contract-info.h, smart-contract-info.inc, define-ton-structure-header.inc</h3>
<p>The <strong>smart-contract-info.h</strong> header file defines SmartContractInfo TON-specific structure. The fields of the structure are declared in <strong>smart-contract-info.inc</strong> file. File <strong>define-ton-structure-header.inc</strong> contains some helper macroses, which declare:</p>
<ul>
<li><strong>SmartContractInfo</strong> structure by itself</li>
<li>builder and cell serialization functions</li>
<li>slice and cell deserialization functions</li>
</ul>
<blockquote>
<p><strong>Note</strong>: Please, refer to the TVM specification for more info on the concept of <em>bag of cells</em>, cell serialization and slice deserialization.</p>
</blockquote>
<p>The <strong>smart-contract-info.inc</strong> defines the contract field structure in the TON_STRUCT macro. The macro lists the supported fields with names, lengths and types.</p>
<pre><code class="Scala">#define TON_STRUCT_NAME SmartContractInfo
#define TON_STRUCT \\
    FIELD_CONSTANT_UNSIGNED(smc_info, 0x076ef1ea, 32) \\
    FIELD_UNSIGNED(actions, 16) \\
    FIELD_UNSIGNED(msgs_sent, 16) \\
    FIELD_UNSIGNED(unixtime, 32) \\
    FIELD_UNSIGNED(block_lt, 64) \\
    FIELD_UNSIGNED(trans_lt, 64) \\
    FIELD_UNSIGNED(rand_seed, 256) \\
    FIELD_COMPLEX(balance_remaining, CurrencyCollection) \\
    FIELD_COMPLEX(myself, MsgAddressInt)
#include HEADER_OR_C
#undef HEADER_OR_C 
</code></pre>

<p>Below is field declarations and macroses in the above code are explained:</p>
<ul>
<li>The first line defines the structure name, <strong>SmartContractInfo</strong> (this macro is used in many points where structure name is necessary).</li>
<li><strong>FIELD_CONSTANT_UNSIGNED</strong> macro defines a constant ("virtual") field which is not really stored within a structure, but its value is placed into a slice at serialization and checked at deserialization.</li>
<li><strong>FIELD_UNSIGNED</strong> no in-depth explanation needed.</li>
<li><strong>FIELD_COMPLEX</strong> allows to define a nested structure.</li>
<li><strong>HEADER_OR_C</strong> macro includes either source or header file depending on the context. This macro is undefined after use to allow declaring the next structure in file (if exists) without warnings that a macro is already declared.</li>
</ul>
<p>This complicated system of includes and macroses defines a lot of useful functions and structures. For example, the function below from the contract returns balance information in compliance with the structure defined in the macro.</p>
<pre><code class="Scala">SmartContractInfo sc_info = get_SmartContractInfo();
int balance = sc_info.balance_remaining.grams.amount; 
</code></pre>

<h3 id="messageh-and-messageinc">message.h and message.inc</h3>
<p>The <strong>message.h</strong> file declares a macro to enable messaging procedures. In refers to the <strong>message.inc</strong> file where actual messaging rules are defined.</p>
<p>The <strong>message.inc</strong> maps messaging rules to structures and fields declared in the <strong>tvm.h</strong> and <strong>define-ton-struct-header.inc</strong> files.</p>
<p>The <strong>arguments.h</strong> file is covered above.</p>
<h2 id="notes-on-the-abi">Notes on the ABI</h2>
<p>Contract messages in TON Labs contracts are formatted according to ABI specifications. Currently only (u)int values are supported.</p></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../../..",
                shortcuts = {"search": 83, "next": 78, "help": 191, "previous": 80};
        </script>
        <script src="../../../js/base.js" defer></script>
        <script src="../../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
